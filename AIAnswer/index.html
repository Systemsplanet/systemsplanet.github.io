<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Answer</title>
    
    <style>
        /* Basic Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* App Body & Font */
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
        }

        /* Main App Container */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        /* Header Area */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background-color: #ffffff;
            border-bottom: 1px solid #dddfe2;
            flex-shrink: 0;
        }

        .link {
            font-size: 0.9rem;
            font-weight: bold;
            color: #007bff;
            text-decoration: none;
        }

        #ai-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #ai-controls label {
            font-size: 0.8rem;
            font-weight: 600;
        }

        #ai-controls select,
        #ai-controls input,
        #ai-controls button {
            font-size: 0.8rem;
            padding: 4px 6px;
            border: 1px solid #ccd0d5;
            border-radius: 4px;
            background-color: #f5f6f7;
        }
        
        #ai-controls input[type="password"] {
            width: 80px;
        }

        #ai-controls button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        #ai-controls button:hover {
            background-color: #0069d9;
        }

        /* Main Content Area */
        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Control Buttons (Listen/Answer) */
        #controls {
            display: flex;
            justify-content: space-around;
            padding: 12px;
            background-color: #ffffff;
            border-bottom: 1px solid #dddfe2;
            flex-shrink: 0;
        }

        #controls button {
            width: 45%;
            padding: 12px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.2s ease;
        }

        #listenBtn {
            color: white;
        }

        #listenBtn[data-value="off"] {
            background-color: #42b72a;
        }

        #listenBtn[data-value="off"]:hover {
            background-color: #36a420;
        }

        #listenBtn[data-value="on"] {
            background-color: #fa383e;
        }

        #listenBtn[data-value="on"]:hover {
            background-color: #e02c30;
        }

        #answerBtn {
            background-color: #007bff;
            color: white;
        }

        #answerBtn:hover {
            background-color: #0069d9;
        }

        #answerBtn:disabled,
        #answerBtn[data-value="on"] {
            background-color: #9dbfff;
            cursor: not-allowed;
            opacity: 0.8;
        }

        /* Question List */
        #questionList-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #ffffff;
            padding: 10px;
        }

        #questionList {
            list-style: none;
        }

        #questionList li {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px;
            background: #f7f8fa;
            border: 1px solid #dddfe2;
            border-radius: 6px;
        }
        
        #questionList li input[type="checkbox"] {
            margin-right: 10px;
            flex-shrink: 0;
            width: 18px;
            height: 18px;
        }
        
        #questionList li input[type="text"] {
            flex-grow: 1;
            border: 1px solid #ccd0d5;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.95rem;
            min-width: 0;
        }

        #questionList li input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        /* Answer Area */
        #answer-container {
            flex-shrink: 0;
            padding: 10px;
            background-color: #ffffff;
            border-top: 1px solid #dddfe2;
            max-height: 40vh;
            overflow-y: auto;
        }

        #ai-model {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        #answer-output {
            background: #f0f2f5;
            border: 1px solid #dddfe2;
            padding: 10px;
            border-radius: 6px;
            min-height: 40px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9rem;
        }

        #read-aloud-toggle {
            display: block;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #4b4f56;
        }

        #read-aloud-toggle input {
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <div id="ai-controls">
                <label for="ai-select">AI:</label>
                <select id="ai-select">
                    <option value="openrouter" selected>openrouter/auto</option>
                </select>
                <label for="api-key-input">Key:</label>
                <input type="password" id="api-key-input" placeholder="API Key">
                <button id="save-api-key-btn" title="Save Key & AI Choice">Save</button>
                <a href="https://github.com/Systemsplanet/systemsplanet.github.io/blob/main/AIAnswer/index.html" target="_blank" class="link">Edit</a>
                <a href="https://openrouter.ai" target="_blank" class="link">OR</a>
            </div>
        </header>

        <main>
            <div id="controls">
                <button id="listenBtn" data-value="off">LISTEN</button>
                <button id="answerBtn" data-value="off">ANSWER</button>
            </div>

            <div id="questionList-container">
                <ul id="questionList"></ul>
            </div>

            <div id="answer-container">
                <div id="ai-model">AI Answer:</div>
                <div id="answer-output">Your AI answer will appear here...</div>
                <label id="read-aloud-toggle">
                    <input type="checkbox" id="read-aloud-checkbox">
                    Read AI reply out loud
                </label>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const listenBtn = document.getElementById('listenBtn');
            const answerBtn = document.getElementById('answerBtn');
            const questionListUL = document.getElementById('questionList');
            const questionListContainer = document.getElementById('questionList-container');
            const answerOutput = document.getElementById('answer-output');
            const aiModel = document.getElementById('ai-model');
            const aiSelect = document.getElementById('ai-select');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const readAloudCheckbox = document.getElementById('read-aloud-checkbox');

            // --- App State ---
            let questionListData = [];
            const MAX_QUESTIONS = 50;
            let recognition;
            let isListening = false;
            let currentAbortController = null;

            // --- LocalStorage Helper Functions ---
            function saveSetting(name, value) {
                try {
                    localStorage.setItem(name, value);
                } catch (e) {
                    console.error("Failed to save setting to localStorage", e);
                    alert("Error: Could not save settings. Storage might be full.");
                }
            }

            function getSetting(name) {
                try {
                    return localStorage.getItem(name);
                } catch (e) {
                    console.error("Failed to get setting from localStorage", e);
                    return null;
                }
            }

            // --- Settings & Storage Management ---
            function loadApiKeyForSelectedAI() {
                const selectedAI = aiSelect.value;
                const savedKey = getSetting(`apiKey_${selectedAI}`);
                apiKeyInput.value = savedKey || '';
            }

            function loadSettings() {
                const savedAI = getSetting('activeAI');
                if (savedAI) {
                    aiSelect.value = savedAI;
                }
                loadApiKeyForSelectedAI();
            }

            function saveSettings() {
                const selectedAI = aiSelect.value;
                const newKey = apiKeyInput.value.trim();
                
                saveSetting(`apiKey_${selectedAI}`, newKey);
                saveSetting('activeAI', selectedAI);
                
                alert('Settings saved.');
                apiKeyInput.blur();
            }

            // --- Question List Management ---
            function renderQuestionList() {
                questionListUL.innerHTML = '';
                
                questionListData.forEach(q => {
                    const li = document.createElement('li');
                    li.dataset.id = q.id;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = q.isSelected;
                    checkbox.addEventListener('change', () => handleCheckboxChange(q.id));

                    const textInput = document.createElement('input');
                    textInput.type = 'text';
                    textInput.value = q.text;
                    textInput.addEventListener('input', (e) => handleTextChange(q.id, e.target.value));

                    li.appendChild(checkbox);
                    li.appendChild(textInput);
                    questionListUL.appendChild(li);
                });
            }

            function handleCheckboxChange(id) {
                const question = questionListData.find(q => q.id === id);
                if (question) {
                    question.isSelected = !question.isSelected;
                }
                renderQuestionList();
            }

            function handleTextChange(id, newText) {
                const question = questionListData.find(q => q.id === id);
                if (question) {
                    question.text = newText;
                }
            }

            function addQuestion(text) {
                const trimmedText = text.trim();
                if (!trimmedText) return;

                if (questionListData.length >= MAX_QUESTIONS) {
                    questionListData.shift(); 
                }

                questionListData.push({
                    id: Date.now(),
                    text: trimmedText,
                    isSelected: false
                });

                renderQuestionList();
                questionListContainer.scrollTop = questionListContainer.scrollHeight;
            }

            // --- Speech Recognition ---
            function setupSpeechRecognition() {
                window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!window.SpeechRecognition) {
                    alert('Speech Recognition is not supported by this browser. Please use Chrome or Firefox.');
                    listenBtn.disabled = true;
                    listenBtn.textContent = 'NOT SUPPORTED';
                    return;
                }

                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        transcript += event.results[i][0].transcript + ' ';
                    }
                    addQuestion(transcript);
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'no-speech' || event.error === 'audio-capture' || event.error === 'network') {
                        // Don't stop for minor errors
                    } else {
                        stopListening();
                    }
                };

                recognition.onend = () => {
                    if (isListening) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error("Could not restart recognition:", e);
                            stopListening();
                        }
                    }
                };
            }

            function startListening() {
                if (!recognition) return;

                try {
                    if (answerBtn.dataset.value === 'on') {
                        if (currentAbortController) {
                            currentAbortController.abort();
                        }
                        answerBtn.dataset.value = 'off';
                        answerBtn.disabled = false;
                        answerBtn.textContent = 'ANSWER';
                    }
                    
                    recognition.start();
                    isListening = true;
                    listenBtn.dataset.value = "on";
                    listenBtn.textContent = "LISTENING...";
                } catch (e) {
                    console.warn("Recognition already started or error starting:", e.message);
                }
            }

            function stopListening() {
                if (isListening) {
                    isListening = false;
                    if (recognition) {
                        recognition.abort();
                    }
                }
                listenBtn.dataset.value = "off";
                listenBtn.textContent = "LISTEN";
            }

            function cleanAiReply(text) {
                if (!text) return "";
                const tokenRegex = /<s>|<\/s>|\[\/s>|\[OUT\]|\[\/OUT\]|\[INST\]|\[\/INST\]|\[USER\]|\[\/USER\]|\[ASSISTANT\]|\[\/ASSISTANT\]/g;
                return text.replace(tokenRegex, "").trim();
            }

            // --- AI Interaction ---
            async function sendToAI(promptText) {
                aiModel.textContent = "AI Reply"
                const selectedAI = aiSelect.value;
                const apiKey = getSetting(`apiKey_${selectedAI}`);

                if (!apiKey) {
                    answerOutput.textContent = `Error: API key for ${selectedAI} is not set. Please set it at the top and click Save.`;
                    return;
                }
                
                currentAbortController = new AbortController();
                const signal = currentAbortController.signal;

                if (selectedAI === 'openrouter') {
                    const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
                    const model = "openrouter/auto";
                    try {
                        answerOutput.textContent = 'Thinking...';
                        //console.info('key:[' + apiKey +"]");
                        console.info("in:["+ promptText + "]");
                
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json',
                                'HTTP-Referer': 'https://github.com/Systemsplanet/systemsplanet.github.io', 
                                'X-Title': 'AI Question Capture'
                            },
                            body: JSON.stringify({
                                model: model,
                             // models: ['mistralai/mistral-7b-instruct:free'],
                                messages: [
                                    { role: 'user', content: promptText }
                                ]
                            }),
                            signal: signal
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            const errorMsg = errorData.error?.message || response.statusText;
                            throw new Error(`API Error (${response.status}): ${errorMsg}`);
                        }

                        const data = await response.json();
                        
                        if (data.choices && data.choices.length > 0) {
                            console.info("out0:["+ data.choices[0].message.content + "]");
                            aiModel.textContent = "AI Reply (" + data.provider + ":" + data.model + ")";
                            const reply = cleanAiReply(data.choices[0].message.content);
                            console.info("out1:["+ reply + "]");
                            answerOutput.textContent = reply;

                            if (readAloudCheckbox.checked) {
                                readAloud(reply);
                            }
                        } else {
                            throw new Error("Invalid response format from AI.");
                        }

                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.log('AI request was cancelled.');
                            answerOutput.textContent = 'Answer cancelled.';
                        } else {
                            console.error('OpenRouter API error:', error);
                            answerOutput.textContent = `Error: ${error.message}`;
                        }
                    }
                } else {
                    answerOutput.textContent = `Error: AI provider '${selectedAI}' is not implemented.`;
                }
            }

            function readAloud(text) {
                if (!('speechSynthesis' in window)) {
                    console.warn('Speech Synthesis not supported.');
                    return;
                }
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            }

            // --- Event Listeners ---
            listenBtn.addEventListener('click', () => {
                if (listenBtn.dataset.value === 'on') {
                    stopListening();
                } else {
                    questionListData.forEach(q => {
                        q.isSelected = false;
                    });
                    renderQuestionList();
                    startListening();
                }
            });

            answerBtn.addEventListener('click', async () => {
                if (answerBtn.dataset.value === 'on') {
                    if (currentAbortController) {
                        currentAbortController.abort();
                    }
                    answerBtn.dataset.value = 'off';
                    answerBtn.disabled = false;
                    answerBtn.textContent = 'ANSWER';
                    return;
                }
                
                answerBtn.dataset.value = 'on';
                answerBtn.disabled = true;
                answerBtn.textContent = 'CANCEL';

                stopListening();

                let selectedQuestions = questionListData.filter(q => q.isSelected);

                if (selectedQuestions.length === 0) {
                    for (let i = questionListData.length - 1; i >= 0; i--) {
                        if (questionListData[i].text.trim()) {
                            questionListData[i].isSelected = true;
                            break;
                        }
                    }
                    renderQuestionList();
                }

                let promptText = "";
                questionListData.forEach(ql => {
                    if (ql.isSelected) {
                        const prompt = ql.text.trim();
                        if (prompt.length > 0) {
                            promptText += prompt + "\n";
                        }
                    }
                });
                
                promptText = promptText.trim();

                if (promptText.length > 0) {
                    if (readAloudCheckbox.checked && 'speechSynthesis' in window) {
                        window.speechSynthesis.cancel();
                        const primingUtterance = new SpeechSynthesisUtterance(' ');
                        primingUtterance.volume = 0;
                        window.speechSynthesis.speak(primingUtterance);
                    }

                    await sendToAI(promptText);
                } else {
                    answerOutput.textContent = 'No selected questions with text to answer.';
                }

                answerBtn.dataset.value = 'off';
                answerBtn.disabled = false;
                answerBtn.textContent = 'ANSWER';
            });

            aiSelect.addEventListener('change', loadApiKeyForSelectedAI);
            saveApiKeyBtn.addEventListener('click', saveSettings);

            // --- Initialization ---
            loadSettings();
            setupSpeechRecognition();
        });
    </script>
</body>
</html>
