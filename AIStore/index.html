<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIStore</title>
  <style>
    /* ... (CSS unchanged) ... */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="app-info">AIStore</h1>
      <p id="status-msg"></p>
      <button id="add-prompt-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
        </svg> Add
      </button>
      <button id="github-settings-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
        </svg> Save
      </button>
    </header>

    <div class="controls">
      <select id="category-filter">
        <option value="*">All Categories</option>
      </select>
      <select id="ai-name-filter">
        <option value="*">All AI Names</option>
      </select>
      <div class="search-group">
        <input type="text" id="search-query" placeholder="Search prompts...">
      </div>
    </div>

    <div class="results-grid">
      <table>
        <thead>
          <tr>
            <th></th>
            <th>Category</th>
            <th>AI Name</th>
            <th>Prompt Name</th>
            <th>Prompt Text</th>
            <th>Notes</th>
            <th>Updated</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="prompts-tbody">
        </tbody>
      </table>
    </div>
  </div>

  <div id="prompt-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Add New Prompt</h2>
        <span class="close-button" id="close-prompt-modal">&times;</span>
      </div>
      <form id="prompt-form" class="modal-form">
        <input type="hidden" id="prompt-index">
        <div class="form-group">
          <label for="prompt-category">Category</label>
          <input type="text" id="prompt-category" required>
        </div>
        <div class="form-group">
          <label for="ai-name">AI Name</label>
          <input type="text" id="ai-name" required>
        </div>
        <div class="form-group">
          <label for="prompt-name">Prompt Name</label>
          <input type="text" id="prompt-name" required>
        </div>
        <div class="form-group">
          <label for="user-id">User ID</label>
          <input type="text" id="user-id">
        </div>
        <div class="form-group full-width">
          <label for="prompt-text">Prompt Text</label>
          <textarea id="prompt-text" required></textarea>
        </div>
        <div class="form-group full-width">
          <label for="notes">Notes</label>
          <textarea id="notes"></textarea>
        </div>
        <small id="duplicate-warning" class="full-width" style="color: var(--error-color); display: none;">
          A prompt with this Category, Prompt Name, and AI Name already exists. You cannot save a duplicate.
        </small>
      </form>
      <div class="modal-footer">
        <button id="cancel-prompt-btn">Cancel</button>
        <button id="save-prompt-btn">Save Prompt</button>
      </div>
    </div>
  </div>

  <div id="github-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Save to GitHub</h2>
        <span class="close-button" id="close-github-modal">&times;</span>
      </div>
      <div id="github-form" class="modal-form">
        <div class="form-group">
          <label for="github-owner">GitHub Owner</label>
          <input type="text" id="github-owner">
        </div>
        <div class="form-group">
          <label for="github-repo">Repository Name</label>
          <input type="text" id="github-repo">
        </div>
        <div class="form-group full-width">
          <label for="github-path">File Path</label>
          <input type="text" id="github-path">
        </div>
        <div class="form-group full-width">
          <label for="github-key">GitHub API Key (Personal Access Token)
            <span id="githubHelpIcon">
              <img src="https://img.icons8.com/ios/24/000000/help--v1.png" alt="Help" title="Click for GitHub API Key instructions">
            </span>
          </label>
          <input type="password" id="github-key">
        </div>
      </div>
      <div class="full-width">
        <label>Log</label>
        <div id="log-area"></div>
      </div>
      <!-- Save to GitHub button has been removed as per your instructions -->
      <!-- <button id="save-to-github-btn">Save to GitHub</button> -->
    </div>
  </div>

  <div id="message-box" class="modal">
    <div id="message-box-content" class="modal-content">
      <h3 id="message-box-title"></h3>
      <p id="message-box-text"></p>
      <div id="message-box-buttons">
        <button id="message-box-ok">OK</button>
      </div>
    </div>
  </div>

  <div id="confirm-box" class="modal">
    <div id="confirm-box-content" class="modal-content">
      <h3 id="confirm-box-title">Confirm Action</h3>
      <p id="confirm-box-text"></p>
      <div id="confirm-box-buttons">
        <button id="confirm-box-yes">Yes</button>
        <button id="confirm-box-no">No</button>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- STATE MANAGEMENT ---
      let prompts = [];
      let copiedRowData = null;
      let githubConfig = {
        owner: 'Systemsplanet',
        repo: 'AIStore',
        path: 'prompts.json',
        apiKey: ''
      };
      const getPromptsUrl = () => {
        return `https://raw.githubusercontent.com/${githubConfig.owner}/${githubConfig.repo}/main/${githubConfig.path}`;
      };

      // --- DOM ELEMENTS ---
      const statusMsg = document.getElementById('status-msg');
      const promptsTbody = document.getElementById('prompts-tbody');
      const searchQuery = document.getElementById('search-query');
      const categoryFilter = document.getElementById('category-filter');
      const aiNameFilter = document.getElementById('ai-name-filter');
      const addInfo = document.getElementById('app-info');

      // Prompt Modal Elements
      const promptModal = document.getElementById('prompt-modal');
      const modalTitle = document.getElementById('modal-title');
      const closePromptModalBtn = document.getElementById('close-prompt-modal');
      const addPromptBtn = document.getElementById('add-prompt-btn');
      const savePromptBtn = document.getElementById('save-prompt-btn');
      const cancelPromptBtn = document.getElementById('cancel-prompt-btn');
      const promptForm = document.getElementById('prompt-form');
      const promptIndexInput = document.getElementById('prompt-index');
      const promptCategoryInput = document.getElementById('prompt-category');
      const promptNameInput = document.getElementById('prompt-name');
      const aiNameInput = document.getElementById('ai-name');
      const userIdInput = document.getElementById('user-id');
      const promptTextInput = document.getElementById('prompt-text');
      const notesInput = document.getElementById('notes');
      const duplicateWarning = document.getElementById('duplicate-warning');

      // GitHub Modal Elements
      const githubModal = document.getElementById('github-modal');
      const githubSettingsBtn = document.getElementById('github-settings-btn');
      const closeGithubModalBtn = document.getElementById('close-github-modal');
      const githubOwnerInput = document.getElementById('github-owner');
      const githubRepoInput = document.getElementById('github-repo');
      const githubPathInput = document.getElementById('github-path');
      const githubKeyInput = document.getElementById('github-key');
      // const saveToGithubBtn = document.getElementById('save-to-github-btn'); // removed (button no longer exists)
      const logArea = document.getElementById('log-area');
      const helpIcon = document.getElementById('githubHelpIcon');

      // Custom Message Box Elements
      const messageBox = document.getElementById('message-box');
      const messageBoxTitle = document.getElementById('message-box-title');
      const messageBoxText = document.getElementById('message-box-text');
      const messageBoxOkBtn = document.getElementById('message-box-ok');

      // Custom Confirmation Box Elements
      const confirmBox = document.getElementById('confirm-box');
      const confirmBoxTitle = document.getElementById('confirm-box-title');
      const confirmBoxText = document.getElementById('confirm-box-text');
      const confirmBoxYesBtn = document.getElementById('confirm-box-yes');
      const confirmBoxNoBtn = document.getElementById('confirm-box-no');

      

      const sortPrompt = (prompts) => {
        prompts.sort((a, b) => {
          const keyA = `${a.category}${a.aiName}${a.promptName}${a.promptText}`;
          const keyB = `${b.category}${b.aiName}${b.promptName}${b.promptText}`;
          return keyA.localeCompare(keyB);
        });
      };

      // --- GITHUB INTEGRATION ---

      const saveToGitHub = async () => {
        // saveToGithubBtn (button) code removed below, since button doesn't exist
        // saveToGithubBtn.disabled = true;
        // saveToGithubBtn.textContent = 'Saving...';
        log('Starting save process to GitHub...', 'info');

        const {
          owner,
          repo,
          path,
          apiKey
        } = githubConfig;
        if (!owner || !repo || !path || !apiKey) {
          log('GitHub configuration is incomplete. Please fill all fields.', 'error');
          // saveToGithubBtn.disabled = false;
          // saveToGithubBtn.textContent = 'Save to GitHub';
          return;
        }

        const GITHUB_API_URL = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const headers = {
          'Authorization': `token ${apiKey}`,
          'Accept': 'application/vnd.github.v3+json',
          'X-GitHub-Api-Version': '2022-11-28'
        };

        try {
          if (prompts.length < 1) throw new Error("GitHub API Error: cant save an empty list");

          log('Fetching current file SHA...', 'info');
          const getFileResponse = await fetch(GITHUB_API_URL, {
            headers
          });
          let sha;
          if (getFileResponse.ok) {
            const fileData = await getFileResponse.json();
            sha = fileData.sha;
            log(`File found. Current SHA: ${sha.substring(0,7)}...`, 'success');
          } else if (getFileResponse.status === 404) {
            log('File not found. This will be a new commit.', 'info');
          } else {
            throw new Error(`Failed to fetch file: ${getFileResponse.status} ${await getFileResponse.text()}`);
          }

          sortPrompt(prompts);
          const contentToSave = JSON.stringify(prompts, null, 2);
          const encodedContent = btoa(unescape(encodeURIComponent(contentToSave)));

          const body = {
            message: `AIStore: Updated prompts.json on ${new Date().toLocaleString()}`,
            content: encodedContent,
            sha: sha,
          };
          if (!sha) delete body.sha;

          log('Uploading new content...', 'info');
          const putResponse = await fetch(GITHUB_API_URL, {
            method: 'PUT',
            headers,
            body: JSON.stringify(body)
          });
          const result = await putResponse.json();

          if (putResponse.ok) {
            log('Successfully saved to GitHub!', 'success');
            log(`Commit URL: ${result.commit.html_url}`, 'info');
            setTimeout(closeGitHubModal, 3000);
          } else {
            throw new Error(`GitHub API Error: ${putResponse.status} - ${result.message || JSON.stringify(result)}`);
          }
        } catch (error) {
          log(`Error: ${error.message}`, 'error');
          console.error(error);
        } finally {
          // saveToGithubBtn.disabled = false;
          // saveToGithubBtn.textContent = 'Save to GitHub';
        }
      };

      // --- PROMPT HANDLING ---

      const savePrompt = () => {
        if (!promptForm.checkValidity()) {
          promptForm.reportValidity();
          return;
        }

        const index = promptIndexInput.value;
        const now = new Date().toISOString();
        const promptData = {
          category: promptCategoryInput.value.trim(),
          aiName: aiNameInput.value.trim(),
          promptName: promptNameInput.value.trim(),
          promptText: promptTextInput.value.trim(),
          userID: userIdInput.value.trim(),
          notes: notesInput.value.trim(),
          dateCreated: now,
          dateUpdated: now
        };

        if (index) {
          promptData.dateCreated = prompts[index].dateCreated;
          prompts[index] = promptData;
        } else {
          promptData.dateCreated = now;
          prompts.push(promptData);
        }
        sortPrompt(prompts);
        filterAndRender();
        populateFilters();
        closePromptModal();
        showMessage('Saved', 'Prompt saved successfully!');
        saveToGitHub(); // <-- ADDED LINE: automatically syncs to GitHub after saving a prompt
      };

      // --- (remainder of initialization/setup code unchanged) ---
      // Event listeners for other components...
      // Modal handling...
      // Message box, Confirm box...
      // Initialization bucket...
      // etc.

      // All other logic matches your original unchanged code.
    });
  </script>
</body>
</html>
