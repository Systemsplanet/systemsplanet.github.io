<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIStore</title>
    <style>
        :root {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2b2b2b;
            --tertiary-bg: #3c3c3c;
            --primary-text: #f0f0f0;
            --secondary-text: #b0b0b0;
            --accent-color: #4a90e2;
            --accent-hover: #5aa1f2;
            --error-color: #e24a4a;
            --success-color: #4ae28a;
            --font-family: 'Inter', sans-serif; /* Changed to Inter */
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--primary-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh; /* Ensure full height */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        header h1 {
            margin: 0;
            color: var(--accent-color);
        }

        .controls {
            display: flex;
            gap: 15px;
            padding: 15px;
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius);
            flex-wrap: wrap;
            align-items: center;
        }

        .search-group {
            flex-grow: 1;
            display: flex;
        }

        .search-group input {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            border-right: none;
        }

        .search-group button {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        input, select {
            padding: 10px;
            border: 1px solid var(--tertiary-bg);
            background-color: var(--primary-bg);
            color: var(--primary-text);
            border-radius: var(--border-radius);
            font-size: 1em;
            box-sizing: border-box; /* Ensures padding doesn't increase total width */
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        button {
            padding: 4px 12px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background-color: var(--accent-hover);
        }
        
        button:disabled {
            background-color: var(--tertiary-bg);
            cursor: not-allowed;
        }

        .results-grid {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        th, td {
            padding: 1px 8px 0px 0px; 
            text-align: left;
            border-bottom: 0px solid var(--tertiary-bg);
            white-space: nowrap;
        }
        
        th {
            background-color: var(--tertiary-bg);
        }

        tbody tr:hover {
            background-color: #253344;
        }

        .truncate {
            max-width: 200px; /* Adjust as needed */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            vertical-align: middle;
        }
        
        .actions-cell {
            display: flex;
            gap: 10px;
        }
        
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: var(--secondary-bg);
            margin: auto;
            padding: 25px;
            border: 1px solid var(--tertiary-bg);
            width: 90%;
            max-width: 600px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            gap: 15px;
            animation: fadeIn 0.3s ease-out; /* Simple animation */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--accent-color);
        }
        
        .close-button {
            color: var(--secondary-text);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover {
            color: var(--primary-text);
        }
        
        .modal-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .modal-form .full-width {
            grid-column: 1 / -1;
        }
        
        .modal-form label {
            font-weight: bold;
            color: var(--secondary-text);
        }
        
        .modal-form input, .modal-form textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid var(--tertiary-bg);
            background-color: var(--primary-bg);
            color: var(--primary-text);
            border-radius: var(--border-radius);
        }
        
        .modal-form textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        #log-area {
            background-color: var(--primary-bg);
            border: 1px solid var(--tertiary-bg);
            border-radius: var(--border-radius);
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        #log-area .log-success { color: var(--success-color); }
        #log-area .log-error { color: var(--error-color); }
        #log-area .log-info { color: var(--secondary-text); }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 140px;
            background-color: var(--accent-color);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -70px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--accent-color) transparent transparent transparent;
        }
        /* Custom Message Box Styles */
        #message-box, #confirm-box {
            display: none;
            position: fixed;
            z-index: 1001; /* Above other modals */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }

        #message-box-content, #confirm-box-content {
            background-color: var(--secondary-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            max-width: 400px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        #message-box-content h3, #confirm-box-content h3 {
            color: var(--accent-color);
            margin-top: 0;
        }

        #message-box-content p, #confirm-box-content p {
            color: var(--primary-text);
            margin-bottom: 0;
        }

        #message-box-buttons, #confirm-box-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        #message-box-buttons button, #confirm-box-buttons button {
            min-width: 80px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-form {
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
            .search-group {
                flex-direction: column;
            }
            .search-group input {
                border-radius: var(--border-radius);
                border-right: 1px solid var(--tertiary-bg);
            }
            .search-group button {
                border-radius: var(--border-radius);
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .controls > *:not(.search-group) {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 id="app-info">AIStore</h1>
            <button id="add-prompt-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                Add Prompt
            </button>
        </header>

        <div class="controls">

            <select id="category-filter">
                <option value="*">All Categories</option>
            </select>
            <select id="ai-name-filter">
                <option value="*">All AI Names</option>
            </select>
            <div class="search-group">
                <input type="text" id="search-query" placeholder="Search prompts...">
            </div>
            <button id="github-settings-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
                Save
            </button>
        </div>
        
        <div class="results-grid">
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>AI Name</th>
                        <th>Prompt Name</th>
                        <th>Prompt Text</th>
                        <th>Notes</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="prompts-tbody">
                    <!-- Prompt rows will be injected here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Edit/Add Prompt Modal -->
    <div id="prompt-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Prompt</h2>
                <span class="close-button" id="close-prompt-modal">&times;</span>
            </div>
            <form id="prompt-form" class="modal-form">
                <input type="hidden" id="prompt-index">
                <div class="form-group">
                    <label for="prompt-category">Category</label>
                    <input type="text" id="prompt-category" required>
                </div>
                <div class="form-group">
                    <label for="ai-name">AI Name</label>
                    <input type="text" id="ai-name" required>
                </div>
                <div class="form-group">
                    <label for="prompt-name">Prompt Name</label>
                    <input type="text" id="prompt-name" required>
                </div>
                <div class="form-group">
                    <label for="user-id">User ID</label>
                    <input type="text" id="user-id">
                </div>
                <div class="form-group full-width">
                    <label for="prompt-text">Prompt Text</label>
                    <textarea id="prompt-text" required></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="notes">Notes</label>
                    <textarea id="notes"></textarea>
                </div>
                <small id="duplicate-warning" class="full-width" style="color: var(--error-color); display: none;">A prompt with this Category, Prompt Name, and AI Name already exists. You cannot save a duplicate.</small>
            </form>
            <div class="modal-footer">
                <button id="cancel-prompt-btn">Cancel</button>
                <button id="save-prompt-btn">Save Prompt</button>
            </div>
        </div>
    </div>

    <!-- GitHub Settings Modal -->
    <div id="github-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save to GitHub</h2>
                <span class="close-button" id="close-github-modal">&times;</span>
            </div>
            <div id="github-form" class="modal-form">
                <div class="form-group">
                    <label for="github-owner">GitHub Owner</label>
                    <input type="text" id="github-owner">
                </div>
                <div class="form-group">
                    <label for="github-repo">Repository Name</label>
                    <input type="text" id="github-repo">
                </div>
                <div class="form-group full-width">
                    <label for="github-path">File Path</label>
                    <input type="text" id="github-path">
                </div>
                <div class="form-group full-width">
                    <label for="github-key">GitHub API Key (Personal Access Token)</label>
                    <input type="password" id="github-key">
                </div>
            </div>
            <div class="full-width">
                <label>Log</label>
                <div id="log-area"></div>
            </div>
            <div class="modal-footer">
                <button id="save-to-github-btn">Save to GitHub</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="modal">
        <div id="message-box-content" class="modal-content">
            <h3 id="message-box-title"></h3>
            <p id="message-box-text"></p>
            <div id="message-box-buttons">
                <button id="message-box-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Box -->
    <div id="confirm-box" class="modal">
        <div id="confirm-box-content" class="modal-content">
            <h3 id="confirm-box-title">Confirm Action</h3>
            <p id="confirm-box-text"></p>
            <div id="confirm-box-buttons">
                <button id="confirm-box-yes">Yes</button>
                <button id="confirm-box-no">No</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let prompts = [];
        let githubConfig = {
            owner: 'Systemsplanet',
            repo: 'AIStore',
            path: 'prompts.json',
            apiKey: ''
        };
        
        // https://raw.githubusercontent.com/Systemsplanet/AIStore/main/prompts.json
        const getPromptsUrl = () => {
            return "https://raw.githubusercontent.com/" + githubConfig.owner + "/" + githubConfig.repo + "/main/" + githubConfig.path;
        };


        // --- DOM ELEMENTS ---
        const promptsTbody = document.getElementById('prompts-tbody');
        const searchQuery = document.getElementById('search-query');
        const categoryFilter = document.getElementById('category-filter');
        const aiNameFilter = document.getElementById('ai-name-filter');

        // Prompt Modal Elements
        const promptModal = document.getElementById('prompt-modal');
        const modalTitle = document.getElementById('modal-title');
        const closePromptModalBtn = document.getElementById('close-prompt-modal');
        const addPromptBtn = document.getElementById('add-prompt-btn');
        const addInfo = document.getElementById('app-info');

        const savePromptBtn = document.getElementById('save-prompt-btn');
        const cancelPromptBtn = document.getElementById('cancel-prompt-btn');
        const promptForm = document.getElementById('prompt-form');
        const promptIndexInput = document.getElementById('prompt-index');
        const promptCategoryInput = document.getElementById('prompt-category');
        const promptNameInput = document.getElementById('prompt-name');
        const aiNameInput = document.getElementById('ai-name');
        const userIdInput = document.getElementById('user-id');
        const promptTextInput = document.getElementById('prompt-text');
        const notesInput = document.getElementById('notes');
        const duplicateWarning = document.getElementById('duplicate-warning');

        // GitHub Modal Elements
        const githubModal = document.getElementById('github-modal');
        const githubSettingsBtn = document.getElementById('github-settings-btn');
        const closeGithubModalBtn = document.getElementById('close-github-modal');
        const githubOwnerInput = document.getElementById('github-owner');
        const githubRepoInput = document.getElementById('github-repo');
        const githubPathInput = document.getElementById('github-path');
        const githubKeyInput = document.getElementById('github-key');
        const saveToGithubBtn = document.getElementById('save-to-github-btn');
        const logArea = document.getElementById('log-area');

        // Custom Message Box Elements
        const messageBox = document.getElementById('message-box');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxText = document.getElementById('message-box-text');
        const messageBoxOkBtn = document.getElementById('message-box-ok');

        // Custom Confirmation Box Elements
        const confirmBox = document.getElementById('confirm-box');
        const confirmBoxTitle = document.getElementById('confirm-box-title');
        const confirmBoxText = document.getElementById('confirm-box-text');
        const confirmBoxYesBtn = document.getElementById('confirm-box-yes');
        const confirmBoxNoBtn = document.getElementById('confirm-box-no');

        // --- CUSTOM ALERT/CONFIRM ---
        const showMessage = (title, message) => {
            messageBoxTitle.textContent = title;
            messageBoxText.textContent = message;
            messageBox.style.display = 'flex';
        };

        const showConfirm = (title, message) => {
            confirmBoxTitle.textContent = title;
            confirmBoxText.textContent = message;
            confirmBox.style.display = 'flex';
            return new Promise((resolve) => {
                confirmBoxYesBtn.onclick = () => {
                    confirmBox.style.display = 'none';
                    resolve(true);
                };
                confirmBoxNoBtn.onclick = () => {
                    confirmBox.style.display = 'none';
                    resolve(false);
                };
            });
        };

        // --- COOKIE HELPERS ---
        const setCookie = (name, value, days) => {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            // Use a very long expiry for "never expires"
            document.cookie = name + "=" + (JSON.stringify(value) || "") + "; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/";
        };

        const getCookie = (name) => {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    try {
                        return JSON.parse(c.substring(nameEQ.length, c.length));
                    } catch(e) {
                        return c.substring(nameEQ.length, c.length);
                    }
                }
            }
            return null;
        };

        // --- LOGGING ---
        const log = (message, type = 'info') => {
            console.log(message);
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEntry.className = `log-${type}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        };
        
        // --- DATA HANDLING ---
        const getPromptUniqueKey = (p) => `${p.category?.toLowerCase()}/${p.promptName?.toLowerCase()}/${p.aiName?.toLowerCase()}`;

        
        const renderPrompts = (filteredPrompts = prompts) => {
            promptsTbody.innerHTML = '';
            if (filteredPrompts.length === 0) {
                const row = promptsTbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7;
                cell.textContent = "No prompts found.";
                cell.style.textAlign = 'center';
                return;
            }
            filteredPrompts.forEach((prompt, index) => {
                const originalIndex = prompts.findIndex(p => p === prompt);
                const row = promptsTbody.insertRow();
                // Corrected property access from camelCase to PascalCase

                log("prompt"+index+":" + JSON.stringify(prompt) )
                row.innerHTML = `
                    <td class="copy-cell" >${prompt.category || ''}</td>
                    <td class="copy-cell" >${prompt.aiName || ''}</td>
                    <td class="copy-cell" >${prompt.promptName || ''}</td>
                    
                    <td class="copy-cell" ><div class="truncate" title="${prompt.promptText || ''}">${(prompt.promptText?.length > 30 ? prompt.promptText.substring(0, 27) + '...' : prompt.promptText) || ''}</div></td>
                    <td class="copy-cell" ><div class="truncate" title="${prompt.notes || ''}">${(prompt.notes?.length > 30 ? prompt.notes.substring(0, 27) + '...' : prompt.notes) || ''}</div></td>
                    <td class="copy-cell" >${prompt.dateUpdated ? new Date(prompt.dateUpdated).toLocaleDateString() : ''}</td>
                    <td class="actions-cell">
                        <div class="tooltip">
                            <button class="copy-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM6 7a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 6 7z"/></svg>
                            </button>
                            <span class="tooltiptext">Copy Prompt</span>
                        </div>
                        <button class="edit-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>
                        </button>
                        <button class="remove-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                        </button>
                    </td>
                `;
                row.querySelectorAll('.copy-cell').forEach(cell => {
                   cell.addEventListener('click', () => copyPromptText(prompt.promptText));
                });
                row.querySelector('.copy-btn').addEventListener('click', () => copyPromptText(prompt.promptText));
                row.querySelector('.edit-btn').addEventListener('click', () => openPromptModal(originalIndex));
                row.querySelector('.remove-btn').addEventListener('click', () => removePrompt(originalIndex));
            });
        };

        
        const populateFilters = () => {
            // Use PascalCase for mapping to match prompt object properties
            const categories = [...new Set(prompts.map(p => p.category))].sort();
            const aiNames = [...new Set(prompts.map(p => p.aiName))].sort();

            // Clear existing options except for the "All" option
            categoryFilter.innerHTML = '<option value="*">All Categories</option>';
            aiNameFilter.innerHTML = '<option value="*">All AI Names</option>';

            categories.forEach(cat => {
                if(cat) {
                    const option = new Option(cat, cat);
                    categoryFilter.add(option);
                }
            });
            aiNames.forEach(name => {
                if(name) {
                    const option = new Option(name, name);
                    aiNameFilter.add(option);
                }
            });
        };

        const filterAndRender = () => {
            const query = searchQuery.value.toLowerCase();
            const category = categoryFilter.value;
            const aiName = aiNameFilter.value;

            const filtered = prompts.filter(p => {
                // Use PascalCase for comparison with prompt object properties
                const categoryMatch = category === '*' || p.category === category;
                const aiNameMatch = aiName === '*' || p.aiName === aiName;
                const queryMatch = !query || 
                    p.category?.toLowerCase().includes(query) ||
                    p.promptName?.toLowerCase().includes(query) ||
                    p.aiName?.toLowerCase().includes(query) ||
                    p.promptText?.toLowerCase().includes(query) ||
                    p.notes?.toLowerCase().includes(query); // Added notes to search
                
                return categoryMatch && aiNameMatch && queryMatch;
            });
            renderPrompts(filtered);
            addInfo.innerHTML = "AIStore (" + filtered.length + ")";
        };
        
        const copyPromptText = (text) => {
            if (!navigator.clipboard) {
                // Fallback for older browsers (document.execCommand is deprecated but more widely supported in sandboxed iframes)
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px"; // Hide off-screen
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    //showMessage('Success', 'Prompt copied to clipboard!');
                } catch (err) {
                    showMessage('Error', 'Failed to copy prompt.');
                }
                document.body.removeChild(textArea);
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                //showMessage('Success', 'Prompt copied to clipboard!');
            }).catch(err => {
                showMessage('Error', 'Failed to copy prompt.');
            });
        };

        const removePrompt = async (index) => {
            //log("removePrompt:[" + index + "]");
            const prompt = prompts[index];
            log("removePrompt:[" +JSON.stringify(prompt, null, 2) + "]");
            const confirmed = await showConfirm('Delete Prompt', `Are you sure you want to delete the prompt "${prompts[index].promptName}"?`);
            //log("removePrompt confirm:[" + confirmed + "]");
         
            if (confirmed) {
                prompts.splice(index, 1);
                filterAndRender();
                populateFilters();
                showMessage('Deleted', 'Prompt successfully deleted.');
            }
        };

        // --- MODAL HANDLING ---
        const openPromptModal = (index = null) => {
            promptForm.reset();
            duplicateWarning.style.display = 'none';
            if (index !== null) {
                const prompt = prompts[index];
                modalTitle.textContent = 'Edit Prompt';
                promptIndexInput.value = index;
                promptCategoryInput.value = prompt.category || '';
                promptNameInput.value = prompt.promptName || '';
                aiNameInput.value = prompt.aiName || '';
                userIdInput.value = prompt.userID || '';
                promptTextInput.value = prompt.promptText || '';
                notesInput.value = prompt.notes || '';
            } else {
                modalTitle.textContent = 'Add New Prompt';
                promptIndexInput.value = '';
            }
            promptModal.style.display = 'flex';
            checkDuplicate(); // Check duplicates immediately when opening for add/edit
        };

        const closePromptModal = () => {
            promptModal.style.display = 'none';
        };
        
        const checkDuplicate = () => {
            const currentIndex = promptIndexInput.value;
            const currentKey = getPromptUniqueKey({
                category: promptCategoryInput.value,
                promptName: promptNameInput.value,
                aiName: aiNameInput.value
            });

            const isDuplicate = prompts.some((p, i) => {
                // It's a duplicate if the key exists and it's not the prompt we are currently editing
                return getPromptUniqueKey(p) === currentKey && i.toString() !== currentIndex;
            });

            if (isDuplicate) {
                duplicateWarning.style.display = 'block';
                savePromptBtn.disabled = true;
            } else {
                duplicateWarning.style.display = 'none';
                savePromptBtn.disabled = false;
            }
        };

        const savePrompt = () => {
            if (!promptForm.checkValidity()) {
                promptForm.reportValidity();
                return;
            }

            const index = promptIndexInput.value;
            const now = new Date().toISOString();
            
            const promptData = {
                category: promptCategoryInput.value.trim(),
                aiName: aiNameInput.value.trim(),
                promptName: promptNameInput.value.trim(),
                promptText: promptTextInput.value.trim(),
                userID: userIdInput.value.trim(),
                notes: notesInput.value.trim(),
                dateCreated: now,
                dateUpdated: now
            };
            
            if (index) { // Editing existing prompt
                promptData.dateCreated = prompts[index].dateCreated; // Preserve original creation date
                prompts[index] = promptData;
            } else { // Adding new prompt
                promptData.dateCreated = now;
                prompts.push(promptData);
            }
            sortPrompt(prompts);
            filterAndRender();
            populateFilters();
            closePromptModal();
            showMessage('Saved', 'Prompt saved successfully!');
        };
        
        const openGitHubModal = () => {
            logArea.innerHTML = ''; // Clear logs
            loadGitHubConfig();
            githubModal.style.display = 'flex';
        };

        const closeGitHubModal = () => {
            githubModal.style.display = 'none';
        };
        
        // --- GITHUB INTEGRATION ---
        const loadGitHubConfig = () => {
            const storedConfig = getCookie('Github');
            if(storedConfig) {
                githubConfig = { ...githubConfig, ...storedConfig };
            }
            githubOwnerInput.value = githubConfig.owner;
            githubRepoInput.value = githubConfig.repo;
            githubPathInput.value = githubConfig.path;
            githubKeyInput.value = githubConfig.apiKey;
        };
        
        const saveGitHubConfig = () => {
            githubConfig.owner = githubOwnerInput.value.trim();
            githubConfig.repo = githubRepoInput.value.trim();
            githubConfig.path = githubPathInput.value.trim();
            githubConfig.apiKey = githubKeyInput.value.trim();
            setCookie('Github', githubConfig);
        };

        const sortPrompt = (prompts) => {
           prompts.sort((a, b) => {
             const keyA = `${a.category}${a.aiName}${a.promptName}${a.promptText}`;
             const keyB = `${b.category}${b.aiName}${b.promptName}${b.promptText}`;
             return keyA.localeCompare(keyB);
           });
        };

        const saveToGitHub = async () => {
            saveToGithubBtn.disabled = true;
            saveToGithubBtn.textContent = 'Saving...';
            log('Starting save process to GitHub...', 'info');

            const { owner, repo, path, apiKey } = githubConfig;

            if (!owner || !repo || !path || !apiKey) {
                log('GitHub configuration is incomplete. Please fill all fields.', 'error');
                saveToGithubBtn.disabled = false;
                saveToGithubBtn.textContent = 'Save to GitHub';
                return;
            }
            
            const GITHUB_API_URL = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            const headers = {
                'Authorization': `token ${apiKey}`,
                'Accept': 'application/vnd.github.v3+json',
                'X-GitHub-Api-Version': '2022-11-28'
            };

            try {
                if (prompts.length < 1 )
                     throw new Error("GitHub API Error: cant save an empty list");
                
                // 1. Get the current file to get its SHA
                log('Fetching current file SHA...', 'info');
                const getFileResponse = await fetch(GITHUB_API_URL, { headers });
                
                let sha;
                if (getFileResponse.ok) {
                    const fileData = await getFileResponse.json();
                    sha = fileData.sha;
                    log(`File found. Current SHA: ${sha.substring(0,7)}...`, 'success');
                } else if (getFileResponse.status === 404) {
                    log('File not found. This will be a new commit.', 'info');
                } else {
                    throw new Error(`Failed to fetch file: ${getFileResponse.status} ${await getFileResponse.text()}`);
                }
                
                // 2. Prepare the content for upload
                sortPrompt(prompts);
                
                const contentToSave = JSON.stringify(prompts, null, 2);
                // encodeURIComponent is crucial for handling non-ASCII characters, then btoa for base64
                const encodedContent = btoa(unescape(encodeURIComponent(contentToSave)));

                // 3. Create or update the file
                const body = {
                    message: `AIStore: Updated prompts.json on ${new Date().toLocaleString()}`, // More readable date
                    content: encodedContent,
                    sha: sha // Include SHA if updating
                };
                if (!sha) delete body.sha; // Don't send SHA for new files

                log('Uploading new content...', 'info');
                const putResponse = await fetch(GITHUB_API_URL, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(body)
                });
                
                const result = await putResponse.json();
                
                if (putResponse.ok) {
                    log('Successfully saved to GitHub!', 'success');
                    log(`Commit URL: ${result.commit.html_url}`, 'info'); // Provide commit URL
                    setTimeout(closeGitHubModal, 3000);
                } else {
                    throw new Error(`GitHub API Error: ${putResponse.status} - ${result.message || JSON.stringify(result)}`);
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                console.error(error);
            } finally {
                saveToGithubBtn.disabled = false;
                saveToGithubBtn.textContent = 'Save to GitHub';
            }
        };

        // --- INITIALIZATION ---
        const initialize = async () => {
            loadGitHubConfig();
            console.log("githubConfig:" + githubConfig);
            let promptsUrl = getPromptsUrl();
            console.log("promptsUrl: [" + promptsUrl + "]");
            try {
                // https://raw.githubusercontent.com/Systemsplanet/AIStore/main/prompts.json
                const response = await fetch(promptsUrl);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const initialPrompts = await response.json();
                if(Array.isArray(initialPrompts)) {
                    prompts = initialPrompts;
                    console.log(`Successfully fetched ${prompts.length} prompts.`);
                } else {
                    console.error("Fetched data is not an array. Initializing with empty prompts.");
                    prompts = []; // Ensure prompts is an array even if fetch fails or returns non-array
                }
            } catch (error) {
                console.error('Failed to fetch initial prompts:', error);
                showMessage('Error', 'Could not load the initial set of prompts. The application may be empty.');
                prompts = []; // Ensure prompts is an array even on fetch error
            }
                            
            sortPrompt(prompts);
            filterAndRender();
            populateFilters();
            setupEventListeners();
        };
        
        const setupEventListeners = () => {
            // Filters
            searchQuery.addEventListener('input', filterAndRender);
            categoryFilter.addEventListener('change', filterAndRender);
            aiNameFilter.addEventListener('change', filterAndRender);
            
            // Prompt Modal
            addPromptBtn.addEventListener('click', () => openPromptModal());
            closePromptModalBtn.addEventListener('click', closePromptModal);
            cancelPromptBtn.addEventListener('click', closePromptModal);
            savePromptBtn.addEventListener('click', savePrompt);
            [promptCategoryInput, promptNameInput, aiNameInput].forEach(input => {
                input.addEventListener('input', checkDuplicate);
            });
            
            // GitHub Modal
            githubSettingsBtn.addEventListener('click', openGitHubModal);
            closeGithubModalBtn.addEventListener('click', closeGitHubModal);
            [githubOwnerInput, githubRepoInput, githubPathInput, githubKeyInput].forEach(input => {
                input.addEventListener('input', saveGitHubConfig); // Changed to input for real-time saving
            });
            saveToGithubBtn.addEventListener('click', saveToGitHub);
            
            // Custom Message Box
            messageBoxOkBtn.addEventListener('click', () => messageBox.style.display = 'none');
            
            // Close modals on outside click
            window.addEventListener('click', (event) => {
                if (event.target === promptModal) closePromptModal();
                if (event.target === githubModal) closeGitHubModal();
                if (event.target === messageBox) messageBox.style.display = 'none';
                if (event.target === confirmBox) confirmBox.style.display = 'none';
            });
        };

        initialize();
    });
    </script>
</body>
</html>
